<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØµÙ†Ø¹ Ø§Ù„Ø±ÙˆØ¨ÙˆØª: ØªØ­Ø¯ÙŠ 8 Ø£Ø¬Ø²Ø§Ø¡</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cairo Font for Arabic (Main Font) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Tone.js for Sound Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f4f8; /* Light background */
        }
        /* New class for the requested font style (Times New Roman or a serif fallback) */
        .font-serif-math {
            font-family: "Times New Roman", Times, serif;
        }
        
        .robot-part {
            position: absolute;
            background-color: #e5e7eb; /* Default light gray for target (locked) */
            border: 3px dashed #9ca3af;
            transition: all 0.5s ease-in-out;
            font-size: 0.875rem; 
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-weight: bold;
        }
        
        /* Active target style (current question) */
        .robot-part.active-target {
            border-color: #f59e0b; /* Amber border */
            background-color: #fef3c7; /* Light amber bg */
            animation: pulse-border 1.5s infinite;
            color: #d97706;
        }

        .robot-part.assembled {
            border-style: solid;
            border-width: 4px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            color: white;
            z-index: 10;
        }

        /* Custom styles for shapes sizes */
        .shape-square { width: 80px; height: 80px; }
        .shape-rect-lg { width: 140px; height: 200px; }
        .shape-rect-arm { width: 30px; height: 100px; }
        .shape-rect-leg { width: 40px; height: 120px; }
        .shape-rect-foot { width: 60px; height: 20px; }

        /* The Robot Assembly Area - Taller to fit legs/feet */
        #robot-assembly {
            position: relative;
            width: 300px;
            height: 600px; 
            margin: 0 auto;
        }

        /* Positions for Robot Parts (Target areas) */
        #target-body { top: 100px; left: 80px; }
        #target-head { top: 20px; left: 110px; }
        #target-arm-l { top: 130px; left: 50px; transform-origin: top left; transform: rotate(-30deg); }
        #target-arm-r { top: 130px; right: 50px; transform-origin: top right; transform: rotate(30deg); }
        #target-leg-l { top: 300px; left: 100px; }
        #target-leg-r { top: 300px; left: 160px; }
        #target-foot-l { top: 425px; left: 90px; }
        #target-foot-r { top: 425px; left: 150px; }
        
        /* Animation for active target */
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }

        /* Animation for correct answer fill */
        @keyframes flash-success {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.2); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .animate-success {
            animation: flash-success 0.5s ease-out;
        }
        
        .question-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            border: 4px solid #3b82f6; /* Blue border */
            min-height: 300px;
            position: relative;
            overflow: hidden;
        }

        /* Timer Bar Styles */
        .timer-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 8px;
            background-color: #e5e7eb;
            z-index: 20;
        }
        
        .timer-bar {
            height: 100%;
            background-color: #10b981; /* Green start */
            transition: width 1s linear, background-color 0.5s ease;
            width: 100%;
        }

        /* Heart Animation */
        @keyframes heart-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .heart-icon {
            display: inline-block;
            transition: transform 0.2s;
        }
        .heart-lost {
            filter: grayscale(100%);
            opacity: 0.3;
            transform: scale(0.8);
        }

        /* Modal Animation */
        @keyframes modal-pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .modal-content {
            animation: modal-pop 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="p-4 md:p-8" onclick="startAudioContext()">

    <script>
        // --- Game State and Constants ---
        const SHAPES_DATA = {
            'head': { type: 'square', color: '#f59e0b', label: 'Ø§Ù„Ø±Ø£Ø³ (Ù…Ø±Ø¨Ø¹)', targetId: 'target-head' },
            'body': { type: 'rectangle', color: '#4f46e5', label: 'Ø§Ù„Ø¬Ø³Ù… (Ù…Ø³ØªØ·ÙŠÙ„)', targetId: 'target-body' },
            'arm-l': { type: 'rectangle-small', color: '#10b981', label: 'Ø§Ù„Ø°Ø±Ø§Ø¹ Ø§Ù„Ø£ÙŠØ³Ø± (Ù…Ø³ØªØ·ÙŠÙ„)', targetId: 'target-arm-l' },
            'arm-r': { type: 'rectangle-small', color: '#10b981', label: 'Ø§Ù„Ø°Ø±Ø§Ø¹ Ø§Ù„Ø£ÙŠÙ…Ù† (Ù…Ø³ØªØ·ÙŠÙ„)', targetId: 'target-arm-r' },
            'leg-l': { type: 'rectangle-leg', color: '#6366f1', label: 'Ø§Ù„Ø³Ø§Ù‚ Ø§Ù„ÙŠØ³Ø±Ù‰ (Ù…Ø³ØªØ·ÙŠÙ„)', targetId: 'target-leg-l' },
            'leg-r': { type: 'rectangle-leg', color: '#6366f1', label: 'Ø§Ù„Ø³Ø§Ù‚ Ø§Ù„ÙŠÙ…Ù†Ù‰ (Ù…Ø³ØªØ·ÙŠÙ„)', targetId: 'target-leg-r' },
            'foot-l': { type: 'rectangle-foot', color: '#ef4444', label: 'Ø§Ù„Ù‚Ø¯Ù… Ø§Ù„ÙŠØ³Ø±Ù‰ (Ù…Ø³ØªØ·ÙŠÙ„)', targetId: 'target-foot-l' },
            'foot-r': { type: 'rectangle-foot', color: '#ef4444', label: 'Ø§Ù„Ù‚Ø¯Ù… Ø§Ù„ÙŠÙ…Ù†Ù‰ (Ù…Ø³ØªØ·ÙŠÙ„)', targetId: 'target-foot-r' },
        };
        
        const PART_KEYS = Object.keys(SHAPES_DATA);
        const TOTAL_PARTS = PART_KEYS.length;
        const TIME_LIMIT_PER_QUESTION = 45; // 45 seconds

        let gameState = {
            step: 0, // 0: Start, 1: Playing, 2: Win, 3: Game Over
            assembledCount: 0,
            parts: {}, 
            score: 0,
            currentQuestionIndex: 0, 
            questions: [],
            isProcessing: false,
            lives: 3,
            timer: null,
            timeLeft: TIME_LIMIT_PER_QUESTION
        };
        
        let isAudioInitialized = false;

        // --- Tone.js Sound Setup ---
        
        const correctSynth = new Tone.MembraneSynth().toDestination();
        const wrongSynth = new Tone.Synth({
            oscillator: { type: "sawtooth" },
            envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 }
        }).toDestination();
        const winSynth = new Tone.PolySynth(Tone.Synth).toDestination();

        function startAudioContext() {
            if (!isAudioInitialized) {
                Tone.start();
                isAudioInitialized = true;
                document.body.removeEventListener('click', startAudioContext);
                document.body.onclick = null;
            }
        }
        
        function playCorrectSound() {
            if (isAudioInitialized) {
                correctSynth.triggerAttackRelease("C5", "8n");
                correctSynth.triggerAttackRelease("E5", "8n", "+0.1");
            }
        }

        function playWrongSound() {
            if (isAudioInitialized) {
                wrongSynth.triggerAttackRelease("A2", "8n");
                wrongSynth.triggerAttackRelease("G2", "8n", "+0.1");
            }
        }

        function playWinSound() {
            if (isAudioInitialized) {
                winSynth.triggerAttackRelease(["C5", "E5", "G5", "C6"], "2n");
            }
        }

        // --- Timer Functions ---

        const startTimer = () => {
            clearInterval(gameState.timer);
            gameState.timeLeft = TIME_LIMIT_PER_QUESTION;
            updateTimerUI();
            
            gameState.timer = setInterval(() => {
                if (gameState.step !== 1 || gameState.isProcessing) return; // Pause if processing or not playing

                gameState.timeLeft--;
                updateTimerUI();

                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    handleTimeOut();
                }
            }, 1000);
        };

        const stopTimer = () => {
            clearInterval(gameState.timer);
        };

        const updateTimerUI = () => {
            const timerBar = document.getElementById('timer-bar');
            if (timerBar) {
                const percentage = (gameState.timeLeft / TIME_LIMIT_PER_QUESTION) * 100;
                timerBar.style.width = `${percentage}%`;
                
                // Color changes based on urgency
                if (percentage > 50) {
                    timerBar.style.backgroundColor = '#10b981'; // Green
                } else if (percentage > 20) {
                    timerBar.style.backgroundColor = '#f59e0b'; // Yellow
                } else {
                    timerBar.style.backgroundColor = '#ef4444'; // Red
                }
            }
        };

        const handleTimeOut = () => {
            playWrongSound();
            loseLife("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!");
        };

        // --- Core Functions ---

        const generateDimensions = () => {
            const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            const usedDims = new Set();

            const getUniqueDims = (minL, maxL, minW, maxW) => {
                let l, w, key, attempts = 0;
                do {
                    l = rand(minL, maxL);
                    w = rand(minW, maxW);
                    key = `${l}-${w}`;
                    attempts++;
                } while ((usedDims.has(key) || l === w) && attempts < 20);
                usedDims.add(key);
                return { l, w };
            };
            
            const getUniqueSquare = (min, max) => {
                 let s, key, attempts = 0;
                 do {
                     s = rand(min, max);
                     key = `${s}-${s}`;
                     attempts++;
                 } while (usedDims.has(key) && attempts < 20);
                 usedDims.add(key);
                 return s;
            }

            const headS = getUniqueSquare(5, 12); 
            const body = getUniqueDims(12, 20, 8, 15);
            const armL = getUniqueDims(8, 14, 2, 5);
            const armR = getUniqueDims(8, 14, 2, 5);
            const legL = getUniqueDims(12, 18, 3, 6);
            const legR = getUniqueDims(12, 18, 3, 6); 
            const footL = getUniqueDims(5, 9, 6, 10);
            const footR = getUniqueDims(5, 9, 6, 10);

            gameState.parts = {
                'head': { s: headS, assembled: false, color: SHAPES_DATA['head'].color },
                'body': { l: body.l, w: body.w, assembled: false, color: SHAPES_DATA['body'].color },
                'arm-l': { l: armL.l, w: armL.w, assembled: false, color: SHAPES_DATA['arm-l'].color },
                'arm-r': { l: armR.l, w: armR.w, assembled: false, color: SHAPES_DATA['arm-r'].color },
                'leg-l': { l: legL.l, w: legL.w, assembled: false, color: SHAPES_DATA['leg-l'].color },
                'leg-r': { l: legR.l, w: legR.w, assembled: false, color: SHAPES_DATA['leg-r'].color },
                'foot-l': { l: footL.l, w: footL.w, assembled: false, color: SHAPES_DATA['foot-l'].color },
                'foot-r': { l: footR.l, w: footR.w, assembled: false, color: SHAPES_DATA['foot-r'].color },
            };
        };

        const generateQuestions = () => {
            const P = gameState.parts;
            gameState.questions = [
                { partKey: 'head', metric: 'Ù…Ø­ÙŠØ· Ø§Ù„Ù…Ø±Ø¨Ø¹', shape: 'Ù…Ø±Ø¨Ø¹', formula: 'Ø§Ù„Ù…Ø­ÙŠØ· = Ø·ÙˆÙ„ Ø§Ù„Ø¶Ù„Ø¹ Ã— Ù¤', dimensions: `Ø·ÙˆÙ„ Ø§Ù„Ø¶Ù„Ø¹: ${P['head'].s} ÙˆØ­Ø¯Ø©`, correctAnswer: P['head'].s * 4, maxScore: 5 },
                { partKey: 'body', metric: 'Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„', shape: 'Ù…Ø³ØªØ·ÙŠÙ„', formula: 'Ø§Ù„Ù…Ø³Ø§Ø­Ø© = Ø§Ù„Ø·ÙˆÙ„ Ã— Ø§Ù„Ø¹Ø±Ø¶', dimensions: `Ø§Ù„Ø·ÙˆÙ„: ${P['body'].l} ÙˆØ­Ø¯Ø©ØŒ Ø§Ù„Ø¹Ø±Ø¶: ${P['body'].w} ÙˆØ­Ø¯Ø©`, correctAnswer: P['body'].l * P['body'].w, maxScore: 5 },
                { partKey: 'arm-l', metric: 'Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„', shape: 'Ù…Ø³ØªØ·ÙŠÙ„', formula: 'Ø§Ù„Ù…Ø³Ø§Ø­Ø© = Ø§Ù„Ø·ÙˆÙ„ Ã— Ø§Ù„Ø¹Ø±Ø¶', dimensions: `Ø§Ù„Ø·ÙˆÙ„: ${P['arm-l'].l} ÙˆØ­Ø¯Ø©ØŒ Ø§Ù„Ø¹Ø±Ø¶: ${P['arm-l'].w} ÙˆØ­Ø¯Ø©`, correctAnswer: P['arm-l'].l * P['arm-l'].w, maxScore: 5 },
                { partKey: 'arm-r', metric: 'Ù…Ø­ÙŠØ· Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„', shape: 'Ù…Ø³ØªØ·ÙŠÙ„', formula: 'Ø§Ù„Ù…Ø­ÙŠØ· = Ù¢ Ã— (Ø§Ù„Ø·ÙˆÙ„ + Ø§Ù„Ø¹Ø±Ø¶)', dimensions: `Ø§Ù„Ø·ÙˆÙ„: ${P['arm-r'].l} ÙˆØ­Ø¯Ø©ØŒ Ø§Ù„Ø¹Ø±Ø¶: ${P['arm-r'].w} ÙˆØ­Ø¯Ø©`, correctAnswer: 2 * (P['arm-r'].l + P['arm-r'].w), maxScore: 5 },
                { partKey: 'leg-l', metric: 'Ù…Ø­ÙŠØ· Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„', shape: 'Ù…Ø³ØªØ·ÙŠÙ„', formula: 'Ø§Ù„Ù…Ø­ÙŠØ· = Ù¢ Ã— (Ø§Ù„Ø·ÙˆÙ„ + Ø§Ù„Ø¹Ø±Ø¶)', dimensions: `Ø§Ù„Ø·ÙˆÙ„: ${P['leg-l'].l} ÙˆØ­Ø¯Ø©ØŒ Ø§Ù„Ø¹Ø±Ø¶: ${P['leg-l'].w} ÙˆØ­Ø¯Ø©`, correctAnswer: 2 * (P['leg-l'].l + P['leg-l'].w), maxScore: 5 },
                { partKey: 'leg-r', metric: 'Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„', shape: 'Ù…Ø³ØªØ·ÙŠÙ„', formula: 'Ø§Ù„Ù…Ø³Ø§Ø­Ø© = Ø§Ù„Ø·ÙˆÙ„ Ã— Ø§Ù„Ø¹Ø±Ø¶', dimensions: `Ø§Ù„Ø·ÙˆÙ„: ${P['leg-r'].l} ÙˆØ­Ø¯Ø©ØŒ Ø§Ù„Ø¹Ø±Ø¶: ${P['leg-r'].w} ÙˆØ­Ø¯Ø©`, correctAnswer: P['leg-r'].l * P['leg-r'].w, maxScore: 5 },
                { partKey: 'foot-l', metric: 'Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„', shape: 'Ù…Ø³ØªØ·ÙŠÙ„', formula: 'Ø§Ù„Ù…Ø³Ø§Ø­Ø© = Ø§Ù„Ø·ÙˆÙ„ Ã— Ø§Ù„Ø¹Ø±Ø¶', dimensions: `Ø§Ù„Ø·ÙˆÙ„: ${P['foot-l'].l} ÙˆØ­Ø¯Ø©ØŒ Ø§Ù„Ø¹Ø±Ø¶: ${P['foot-l'].w} ÙˆØ­Ø¯Ø©`, correctAnswer: P['foot-l'].l * P['foot-l'].w, maxScore: 5 },
                { partKey: 'foot-r', metric: 'Ù…Ø­ÙŠØ· Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„', shape: 'Ù…Ø³ØªØ·ÙŠÙ„', formula: 'Ø§Ù„Ù…Ø­ÙŠØ· = Ù¢ Ã— (Ø§Ù„Ø·ÙˆÙ„ + Ø§Ù„Ø¹Ø±Ø¶)', dimensions: `Ø§Ù„Ø·ÙˆÙ„: ${P['foot-r'].l} ÙˆØ­Ø¯Ø©ØŒ Ø§Ù„Ø¹Ø±Ø¶: ${P['foot-r'].w} ÙˆØ­Ø¯Ø©`, correctAnswer: 2 * (P['foot-r'].l + P['foot-r'].w), maxScore: 5 },
            ];
            gameState.currentQuestionIndex = 0; 
        }

        // --- Logic: Life Lost ---
        const loseLife = (reason = "Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©") => {
            gameState.lives--;
            updateHeaderUI(); // Update hearts
            
            const feedbackEl = document.getElementById('calculation-feedback');
            const inputField = document.getElementById('calculation-input');

            if (gameState.lives <= 0) {
                // Game Over
                stopTimer();
                gameState.step = 3; // Game Over state
                if(feedbackEl) {
                    feedbackEl.innerHTML = `âŒ ${reason}. Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª!`;
                    feedbackEl.className = 'mt-4 text-center font-bold text-red-600';
                }
                setTimeout(() => updateUI(), 1000);
            } else {
                // Retry
                if(feedbackEl) {
                    feedbackEl.innerHTML = `âŒ ${reason}. Ø®Ø³Ø±Øª Ù‚Ù„Ø¨Ø§Ù‹! (Ù…ØªØ¨Ù‚ÙŠ ${gameState.lives})`;
                    feedbackEl.className = 'mt-4 text-center font-bold text-red-600 animate-pulse';
                }
                
                // Clear input and reset timer for another try
                if(inputField) {
                    inputField.value = '';
                    inputField.focus();
                }
                
                // Brief pause then reset timer
                stopTimer();
                setTimeout(() => {
                    if (gameState.step === 1) startTimer();
                    if(feedbackEl) feedbackEl.textContent = "";
                }, 1500);
            }
        };

        // --- Calculation Logic ---

        window.submitAnswer = () => {
            if (gameState.isProcessing || gameState.step !== 1) return;

            const question = gameState.questions[gameState.currentQuestionIndex];
            const inputField = document.getElementById('calculation-input');
            const feedbackEl = document.getElementById('calculation-feedback');
            
            const userAnswer = parseInt(inputField.value.trim(), 10);
            
            if (isNaN(userAnswer)) {
                feedbackEl.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø±Ù‚Ù…ÙŠØ© ØµØ­ÙŠØ­Ø©.';
                feedbackEl.classList.remove('text-green-600', 'text-indigo-600');
                feedbackEl.classList.add('text-red-600');
                inputField.focus();
                return;
            }
            
            if (userAnswer === Math.round(question.correctAnswer)) {
                // Correct
                stopTimer();
                gameState.isProcessing = true;
                playCorrectSound();

                gameState.score += question.maxScore;
                gameState.parts[question.partKey].assembled = true; 
                gameState.assembledCount++;

                feedbackEl.innerHTML = `ğŸ‰ Ø£Ø­Ø³Ù†Øª! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©.`;
                feedbackEl.className = 'mt-4 text-center font-bold text-green-600 text-lg';
                inputField.disabled = true;
                document.getElementById('submit-btn').classList.add('hidden');

                updateUI(); // Updates the visual robot

                const targetPartEl = document.getElementById(SHAPES_DATA[question.partKey].targetId);
                if(targetPartEl) targetPartEl.classList.add('animate-success');

                setTimeout(() => {
                    if (gameState.assembledCount < TOTAL_PARTS) {
                        gameState.currentQuestionIndex++;
                        gameState.isProcessing = false;
                        updateUI();
                        startTimer(); // Start timer for next question
                    } else {
                        gameState.step = 2; // Win
                        gameState.isProcessing = false;
                        playWinSound();
                        updateUI();
                    }
                }, 1500);

            } else {
                // Wrong Answer
                playWrongSound();
                loseLife("Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©");
            }
        }
        
        // --- UI Rendering ---

        // Helper to generate hearts HTML
        const getHeartsHTML = () => {
            let html = '';
            for (let i = 0; i < 3; i++) {
                if (i < gameState.lives) {
                    html += '<span class="text-2xl text-red-500 mx-1 heart-icon">â¤ï¸</span>';
                } else {
                    html += '<span class="text-2xl text-gray-300 mx-1 heart-icon heart-lost">ğŸ’”</span>';
                }
            }
            return html;
        };

        const updateHeaderUI = () => {
            const scoreEl = document.getElementById('score-value');
            if (scoreEl) scoreEl.textContent = gameState.score;

            const stepEl = document.getElementById('step-name');
            if (stepEl) stepEl.textContent = getCurrentStepName();

            const heartsContainer = document.getElementById('hearts-container');
            if (heartsContainer) heartsContainer.innerHTML = getHeartsHTML();
        };

        const renderStep1QuizAndAssembly = () => {
            const container = document.getElementById('game-content');
            const question = gameState.questions[gameState.currentQuestionIndex];
            const partToUnlock = SHAPES_DATA[question.partKey];
            const partData = gameState.parts[question.partKey];

            // 1. Robot Targets
            const robotTargets = PART_KEYS.map(key => {
                const data = SHAPES_DATA[key];
                const part = gameState.parts[key];
                let shapeClass = '';
                if (data.type === 'rectangle') shapeClass = 'shape-rect-lg';
                if (data.type === 'square') shapeClass = 'shape-square';
                if (data.type === 'rectangle-small') shapeClass = 'shape-rect-arm';
                if (data.type === 'rectangle-leg') shapeClass = 'shape-rect-leg';
                if (data.type === 'rectangle-foot') shapeClass = 'shape-rect-foot';

                const assembledClass = part.assembled ? 'assembled' : '';
                const targetClass = (!part.assembled && key === question.partKey) ? 'active-target' : '';
                const styleAttr = part.assembled ? `style="background-color: ${part.color}; border-color: ${part.color};"` : '';
                let content = data.label.split('(')[0].trim();
                if (!part.assembled && key === question.partKey) content = "?";

                return `<div id="${data.targetId}" class="robot-part ${shapeClass} ${assembledClass} ${targetClass}" ${styleAttr}>${content}</div>`;
            }).join('');

            // 2. Calculation Card
            const calculationCard = `
                <div class="question-card h-full flex flex-col justify-center relative">
                    <!-- Timer Bar -->
                    <div class="timer-container">
                        <div id="timer-bar" class="timer-bar"></div>
                    </div>
                    
                    <div class="mt-4">
                        <h3 class="text-2xl font-black text-blue-700 mb-2">
                            ğŸ’¡ Ø§Ù„Ø³Ø¤Ø§Ù„ ${gameState.currentQuestionIndex + 1} Ù…Ù† ${TOTAL_PARTS}
                        </h3>
                        <p class="text-lg text-gray-700 mb-4">
                            Ø±ÙƒØ¨ Ø¬Ø²Ø¡: <span class="font-bold text-red-600">${partToUnlock.label.split('(')[0].trim()}</span>
                        </p>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4">
                         <p class="text-md text-gray-700 mb-1">Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯:</p>
                         <p class="font-mono text-xl text-indigo-700 font-bold" dir="ltr">${question.dimensions}</p>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-lg mb-6 border-l-4 border-blue-500 font-serif-math">
                        <p class="font-bold text-lg text-blue-800 mb-2">Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†:</p>
                        <p class="text-lg text-blue-900">
                             ${question.shape === 'Ù…Ø±Ø¨Ø¹' 
                                 ? (question.metric.includes('Ù…Ø³Ø§Ø­Ø©') ? 'Ø§Ù„Ù…Ø³Ø§Ø­Ø© = Ø§Ù„Ø¶Ù„Ø¹ Ã— Ø§Ù„Ø¶Ù„Ø¹' : 'Ø§Ù„Ù…Ø­ÙŠØ· = Ø§Ù„Ø¶Ù„Ø¹ Ã— Ù¤')
                                 : (question.metric.includes('Ù…Ø³Ø§Ø­Ø©') ? 'Ø§Ù„Ù…Ø³Ø§Ø­Ø© = Ø§Ù„Ø·ÙˆÙ„ Ã— Ø§Ù„Ø¹Ø±Ø¶' : 'Ø§Ù„Ù…Ø­ÙŠØ· = Ù¢ Ã— (Ø§Ù„Ø·ÙˆÙ„ + Ø§Ù„Ø¹Ø±Ø¶)')
                             }
                        </p>
                    </div>

                    <label for="calculation-input" class="block text-lg font-medium text-gray-800 mb-2">
                        Ø§Ø­Ø³Ø¨ <span class="font-bold">${question.metric}</span>:
                    </label>
                    <div class="flex gap-2">
                        <input type="number" id="calculation-input" min="1" 
                            class="flex-1 p-3 border-2 border-gray-300 rounded-lg text-2xl text-center focus:border-indigo-500 focus:ring-indigo-500 transition" 
                            placeholder="Ø§Ù„Ù†ØªÙŠØ¬Ø©" 
                            ${partData.assembled ? 'disabled' : ''}
                            onkeydown="if(event.key === 'Enter') submitAnswer()"
                        />
                    </div>
                    
                    <div class="mt-4">
                        <button onclick="submitAnswer()" id="submit-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-150 shadow-md ${partData.assembled ? 'hidden' : ''}">
                            ØªØ£ÙƒÙŠØ¯ ÙˆØªØ±ÙƒÙŠØ¨
                        </button>
                    </div>
                    
                    <div id="calculation-feedback" class="h-8"></div>
                </div>
            `;

            container.innerHTML = `
                <div class="flex flex-col lg:flex-row gap-8 h-full">
                    <div class="lg:w-5/12">${calculationCard}</div>
                    <div class="lg:w-7/12 p-6 bg-white rounded-xl shadow-inner border-2 border-gray-100 flex items-center justify-center relative">
                        <h4 class="absolute top-4 right-4 text-gray-400 font-bold text-sm">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹</h4>
                        <div id="robot-assembly">${robotTargets}</div>
                    </div>
                </div>
            `;
        };
        
        const renderStep2Complete = () => {
            const container = document.getElementById('game-content');
            
            // 1. Render the Success Screen (WITHOUT Play Again Button)
            container.innerHTML = `
                <div class="text-center p-10 bg-green-50 rounded-xl shadow-inner border-2 border-green-200">
                    <span class="text-8xl block mb-4 animate-bounce">ğŸ¤–</span>
                    <h2 class="text-4xl font-black text-green-700 mb-4">ØªÙ… Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø±ÙˆØ¨ÙˆØª!</h2>
                    <p class="text-xl text-gray-700 mb-6">Ø£Ø¯Ø§Ø¡ Ø±Ø§Ø¦Ø¹! Ù„Ù‚Ø¯ Ø­Ø§ÙØ¸Øª Ø¹Ù„Ù‰ ${gameState.lives} Ù‚Ù„ÙˆØ¨.</p>
                    <div class="bg-white inline-block px-8 py-4 rounded-lg shadow-md mb-8">
                        <p class="text-gray-500 text-sm mb-1">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</p>
                        <p class="text-5xl font-extrabold text-indigo-600">${gameState.score}</p>
                    </div>
                    <!-- Play Again Button Removed -->
                </div>
            `;

            // 2. Append the Modal (Popup) with the Reward Link
            // We use standard DOM methods to ensure it's appended correctly on top
            if (!document.getElementById('reward-modal')) {
                const modal = document.createElement('div');
                modal.id = 'reward-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm';
                modal.innerHTML = `
                    <div class="modal-content bg-white p-8 rounded-2xl shadow-2xl text-center max-w-lg mx-4 border-4 border-yellow-400 relative">
                        <div class="absolute -top-10 left-1/2 transform -translate-x-1/2 text-6xl">ğŸ†</div>
                        <h2 class="text-3xl font-black text-gray-800 mt-8 mb-4">Ø£Ø­Ø³Ù†Øª ÙŠØ§ Ø¨Ø·Ù„!</h2>
                        <p class="text-gray-600 mb-8 text-lg font-bold">Ù„Ù‚Ø¯ Ù†Ø¬Ø­Øª ÙÙŠ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±ÙˆØ¨ÙˆØª ÙˆØ­Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø¦Ù„.</p>
                        
                        <a href="https://talented-nation.github.io/database/reward3.html" 
                           class="block w-full bg-gradient-to-r from-yellow-400 to-yellow-600 hover:from-yellow-500 hover:to-yellow-700 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg transition transform hover:scale-105 hover:shadow-xl">
                            Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© ğŸ
                        </a>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        };

        const renderStep3GameOver = () => {
            const container = document.getElementById('game-content');
            container.innerHTML = `
                <div class="text-center p-10 bg-red-50 rounded-xl shadow-inner border-2 border-red-200">
                    <span class="text-8xl block mb-4">ğŸ’”</span>
                    <h2 class="text-4xl font-black text-red-700 mb-4">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h2>
                    <p class="text-xl text-gray-700 mb-6">Ù„Ù‚Ø¯ Ù†ÙØ¯Øª Ù…Ø­Ø§ÙˆÙ„Ø§ØªÙƒ. Ø­Ø¸Ø§Ù‹ Ø£ÙˆÙØ± ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.</p>
                    <div class="bg-white inline-block px-8 py-4 rounded-lg shadow-md mb-8">
                        <p class="text-gray-500 text-sm mb-1">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªÙŠ Ø¬Ù…Ø¹ØªÙ‡Ø§</p>
                        <p class="text-5xl font-extrabold text-gray-600">${gameState.score}</p>
                    </div>
                    <!-- Play Again Button Removed -->
                </div>
            `;
        };
        
        const getCurrentStepName = () => {
            if (gameState.step === 2) return 'Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡';
            if (gameState.step === 3) return 'Ø®Ø³Ø§Ø±Ø©';
            return `ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø²Ø¡ ${gameState.currentQuestionIndex + 1} Ù…Ù† 8`;
        }

        window.updateUI = () => {
            updateHeaderUI();

            if (gameState.step === 1) {
                renderStep1QuizAndAssembly();
            } else if (gameState.step === 2) {
                 renderStep2Complete();
            } else if (gameState.step === 3) {
                renderStep3GameOver();
            }
        };
        
        window.initializeGame = () => {
            // cleanup modal if exists from previous game
            const modal = document.getElementById('reward-modal');
            if(modal) modal.remove();

            gameState = {
                step: 1, 
                assembledCount: 0,
                parts: {},
                score: 0,
                currentQuestionIndex: 0, 
                questions: [],
                isProcessing: false,
                lives: 3,
                timeLeft: TIME_LIMIT_PER_QUESTION,
                timer: null
            };
            
            generateDimensions();
            generateQuestions();
            updateUI();
            startTimer(); // Start timer immediately
        }

        window.onload = initializeGame;
    </script>

    <div class="max-w-6xl mx-auto space-y-6">
        <header class="text-center bg-white p-4 md:p-6 rounded-xl shadow-lg border-b-4 border-blue-500 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-right w-full md:w-auto">
                <h1 class="text-2xl md:text-3xl font-black text-gray-900">Ù…ØµÙ†Ø¹ Ø§Ù„Ø±ÙˆØ¨ÙˆØª</h1>
                <p class="text-sm text-gray-500">ØªØ­Ø¯ÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ÙˆØ§Ù„ØªØ¬Ù…ÙŠØ¹</p>
            </div>
            
            <div class="flex gap-4 items-center justify-between w-full md:w-auto">
                <!-- Hearts Display -->
                <div class="bg-red-50 px-4 py-2 rounded-lg border border-red-100 flex flex-col items-center">
                    <span class="text-xs text-gray-500 font-bold mb-1">Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</span>
                    <div id="hearts-container" class="flex">
                        <!-- Hearts injected via JS -->
                    </div>
                </div>

                <div class="bg-gray-50 px-4 py-2 rounded-lg border border-gray-200 text-center">
                    <span class="block text-xs text-gray-500 font-bold">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</span>
                    <span id="step-name" class="font-bold text-blue-600 text-sm">...</span>
                </div>
                
                <div class="bg-indigo-50 px-4 py-2 rounded-lg border border-indigo-200 text-center">
                    <span class="block text-xs text-gray-500 font-bold">Ø§Ù„Ù†Ù‚Ø§Ø·</span>
                    <span id="score-value" class="font-bold text-indigo-600 text-xl">0</span>
                </div>
            </div>
        </header>

        <div id="game-content" class="bg-white p-6 md:p-8 rounded-xl shadow-2xl min-h-[600px]">
            <!-- Content injected here -->
        </div>
    </div>

</body>
</html>
